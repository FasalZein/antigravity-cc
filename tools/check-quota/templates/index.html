<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antigravity Quota Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: {
                            primary: '#0a0a0a',
                            secondary: '#141414',
                            tertiary: '#1a1a1a',
                            hover: '#222222',
                        },
                        border: {
                            subtle: '#262626',
                            DEFAULT: '#333333',
                        },
                        text: {
                            primary: '#e5e5e5',
                            secondary: '#a3a3a3',
                            muted: '#737373',
                        },
                        status: {
                            healthy: '#22c55e',
                            caution: '#eab308',
                            critical: '#ef4444',
                        }
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'monospace'],
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .font-mono, [class*="font-mono"] { font-family: 'JetBrains Mono', monospace !important; }

        /* Progress bar animations */
        .progress-fill {
            transition: width 0.4s ease-out;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #141414; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* Modal */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        .modal-enter { animation: modal-in 0.15s ease-out; }
        @keyframes modal-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Countdown ring */
        .countdown-ring {
            transform: rotate(-90deg);
            transform-origin: center;
        }
        .countdown-ring circle {
            transition: stroke-dashoffset 0.3s ease-out;
        }

        /* Email blur for screenshots */
        .blur-email {
            filter: blur(6px);
            user-select: none;
        }
    </style>
</head>
<body class="bg-bg-primary min-h-screen text-text-primary">
    <!-- Header -->
    <header class="bg-bg-secondary border-b border-border-subtle sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <h1 class="text-lg font-semibold text-white">Antigravity</h1>
                    <span class="text-xs text-text-muted font-mono">Quota Monitor</span>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Hide Email Toggle -->
                    <button onclick="toggleEmailVisibility()" id="emailToggle"
                        class="flex items-center gap-1.5 px-2 py-1 text-xs text-text-secondary hover:text-text-primary transition-colors" title="Toggle email visibility for screenshots">
                        <svg id="eyeIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span class="hidden sm:inline">Hide emails</span>
                    </button>

                    <!-- Last Updated -->
                    <div class="text-right hidden sm:block">
                        <span class="text-xs text-text-muted">Last sync</span>
                        <span id="lastUpdated" class="text-xs font-mono text-text-secondary ml-1">{{.LastUpdated}}</span>
                    </div>

                    <!-- Countdown + Refresh -->
                    <div class="flex items-center gap-2">
                        <div class="relative w-7 h-7" title="Auto-refresh countdown">
                            <svg class="countdown-ring w-7 h-7" viewBox="0 0 32 32">
                                <circle cx="16" cy="16" r="14" fill="none" stroke="#262626" stroke-width="2"/>
                                <circle id="countdownCircle" cx="16" cy="16" r="14" fill="none" stroke="#525252" stroke-width="2"
                                    stroke-dasharray="87.96" stroke-dashoffset="0" stroke-linecap="round"/>
                            </svg>
                            <span id="countdownText" class="absolute inset-0 flex items-center justify-center text-[10px] font-mono text-text-muted">5m</span>
                        </div>

                        <button onclick="refreshData()" id="refreshBtn"
                            class="flex items-center gap-1.5 px-3 py-1.5 bg-bg-tertiary hover:bg-bg-hover border border-border-subtle rounded text-text-secondary hover:text-text-primary text-xs font-medium transition-colors">
                            <svg id="refreshIcon" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <span class="hidden sm:inline">Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-6">
        <!-- Summary Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
            <!-- Total Accounts -->
            <div class="bg-bg-secondary rounded-lg p-4 border border-border-subtle">
                <p class="text-xs text-text-muted uppercase tracking-wide mb-1">Accounts</p>
                <p id="totalAccounts" class="text-2xl font-semibold text-white font-mono">{{.TotalAccounts}}</p>
            </div>

            <!-- Claude -->
            <div class="bg-bg-secondary rounded-lg p-4 border border-border-subtle">
                <p class="text-xs text-text-muted uppercase tracking-wide mb-1">Claude</p>
                <p id="claudeAvg" class="text-2xl font-semibold text-white font-mono">--</p>
            </div>

            <!-- Gemini Pro -->
            <div class="bg-bg-secondary rounded-lg p-4 border border-border-subtle">
                <p class="text-xs text-text-muted uppercase tracking-wide mb-1">Gemini Pro</p>
                <p id="geminiProAvg" class="text-2xl font-semibold text-white font-mono">--</p>
            </div>

            <!-- Gemini Flash -->
            <div class="bg-bg-secondary rounded-lg p-4 border border-border-subtle">
                <p class="text-xs text-text-muted uppercase tracking-wide mb-1">Gemini Flash</p>
                <p id="geminiFlashAvg" class="text-2xl font-semibold text-white font-mono">--</p>
            </div>
        </div>

        <!-- Accounts Grid -->
        <div id="accountsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            {{range $idx, $account := .Accounts}}
            <div class="bg-bg-secondary rounded-lg border border-border-subtle overflow-hidden" data-email="{{.Email}}">
                <!-- Account Header -->
                <div class="px-4 py-3 border-b border-border-subtle flex items-center justify-between">
                    <div class="min-w-0 flex-1">
                        <p class="email-text text-sm text-text-primary truncate font-mono">{{.Email}}</p>
                        {{if .Error}}
                        <p class="text-xs text-status-critical mt-0.5">{{.Error}}</p>
                        {{else}}
                        <p class="text-xs text-text-muted mt-0.5">{{len .Quotas}} models</p>
                        {{end}}
                    </div>
                    {{if not .Error}}
                    <button onclick="showDetails('{{.Email}}')" class="text-text-muted hover:text-text-primary p-1 transition-colors" title="View all models">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                        </svg>
                    </button>
                    {{end}}
                </div>

                {{if not .Error}}
                <!-- Quota Bars -->
                <div class="p-4 space-y-3">
                    {{/* Claude First */}}
                    {{with index .GroupQuotas "Claude"}}
                    <div class="space-y-1">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-text-secondary">Claude</span>
                            <span class="font-mono {{if ge .MinPercent 50.0}}text-status-healthy{{else if ge .MinPercent 20.0}}text-status-caution{{else}}text-status-critical{{end}}">
                                {{printf "%.0f" .MinPercent}}%
                            </span>
                        </div>
                        <div class="h-1.5 bg-bg-tertiary rounded-full overflow-hidden">
                            <div class="progress-fill h-full rounded-full {{if ge .MinPercent 50.0}}bg-status-healthy{{else if ge .MinPercent 20.0}}bg-status-caution{{else}}bg-status-critical{{end}}"
                                style="width: {{.MinPercent}}%"></div>
                        </div>
                    </div>
                    {{end}}

                    {{/* Gemini Pro Second */}}
                    {{with index .GroupQuotas "Gemini Pro"}}
                    <div class="space-y-1">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-text-secondary">Gemini Pro</span>
                            <span class="font-mono {{if ge .MinPercent 50.0}}text-status-healthy{{else if ge .MinPercent 20.0}}text-status-caution{{else}}text-status-critical{{end}}">
                                {{printf "%.0f" .MinPercent}}%
                            </span>
                        </div>
                        <div class="h-1.5 bg-bg-tertiary rounded-full overflow-hidden">
                            <div class="progress-fill h-full rounded-full {{if ge .MinPercent 50.0}}bg-status-healthy{{else if ge .MinPercent 20.0}}bg-status-caution{{else}}bg-status-critical{{end}}"
                                style="width: {{.MinPercent}}%"></div>
                        </div>
                    </div>
                    {{end}}

                    {{/* Gemini Flash Third */}}
                    {{with index .GroupQuotas "Gemini Flash"}}
                    <div class="space-y-1">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-text-secondary">Gemini Flash</span>
                            <span class="font-mono {{if ge .MinPercent 50.0}}text-status-healthy{{else if ge .MinPercent 20.0}}text-status-caution{{else}}text-status-critical{{end}}">
                                {{printf "%.0f" .MinPercent}}%
                            </span>
                        </div>
                        <div class="h-1.5 bg-bg-tertiary rounded-full overflow-hidden">
                            <div class="progress-fill h-full rounded-full {{if ge .MinPercent 50.0}}bg-status-healthy{{else if ge .MinPercent 20.0}}bg-status-caution{{else}}bg-status-critical{{end}}"
                                style="width: {{.MinPercent}}%"></div>
                        </div>
                    </div>
                    {{end}}
                </div>
                {{end}}
            </div>
            {{end}}
        </div>

        {{if eq .TotalAccounts 0}}
        <!-- Empty State -->
        <div class="text-center py-16">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-bg-secondary rounded-xl mb-4">
                <svg class="w-8 h-8 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
            </div>
            <h2 class="text-lg font-semibold text-white mb-2">No Accounts Found</h2>
            <p class="text-text-muted text-sm">
                No auth files found in <code class="bg-bg-secondary px-1.5 py-0.5 rounded font-mono text-xs">~/.cli-proxy-api/</code>
            </p>
        </div>
        {{end}}
    </main>

    <!-- Footer -->
    <footer class="border-t border-border-subtle mt-6 py-4">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex items-center justify-center gap-3 text-xs text-text-muted">
                <span class="flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-status-healthy"></span>
                    Live
                </span>
                <span class="text-border">|</span>
                <span>Auto-refresh <span class="font-mono">5m</span></span>
                <span class="text-border">|</span>
                <kbd class="px-1 py-0.5 bg-bg-secondary rounded text-[10px] font-mono">Ctrl+C</kbd>
                <span>to stop</span>
            </div>
        </div>
    </footer>

    <!-- Modal for Model Details -->
    <div id="modal" class="fixed inset-0 z-50 hidden" onclick="closeModal(event)">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="relative flex items-center justify-center min-h-screen p-4">
            <div class="modal-enter bg-bg-secondary border border-border rounded-lg shadow-2xl w-full max-w-lg max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
                <div class="flex items-center justify-between px-4 py-3 border-b border-border-subtle">
                    <h3 id="modalTitle" class="text-sm font-medium text-white font-mono truncate"></h3>
                    <button onclick="closeModal()" class="text-text-muted hover:text-text-primary p-1 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="modalContent" class="p-4 overflow-y-auto max-h-[60vh] space-y-2">
                    <!-- Model list will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initial data from server
        let dashboardData = {{json .}};
        let countdown = 300;
        let countdownInterval;
        let isRefreshing = false;
        let emailsHidden = false;

        const REFRESH_INTERVAL = 300;
        const CIRCLE_CIRCUMFERENCE = 87.96;

        // Toggle email visibility
        function toggleEmailVisibility() {
            emailsHidden = !emailsHidden;
            const emails = document.querySelectorAll('.email-text');
            const icon = document.getElementById('eyeIcon');

            emails.forEach(el => {
                if (emailsHidden) {
                    el.classList.add('blur-email');
                } else {
                    el.classList.remove('blur-email');
                }
            });

            // Update icon
            if (emailsHidden) {
                icon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                `;
            } else {
                icon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                `;
            }
        }

        // Show model details modal
        function showDetails(email) {
            const account = dashboardData.accounts.find(a => a.email === email);
            if (!account || !account.quotas) return;

            const modal = document.getElementById('modal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');

            title.textContent = emailsHidden ? '********@****' : email;

            // Sort quotas by group then by percentage
            const sortedQuotas = [...account.quotas].sort((a, b) => {
                const groupOrder = { 'Claude': 0, 'Gemini Pro': 1, 'Gemini Flash': 2, 'Other': 3 };
                const groupDiff = (groupOrder[a.group] || 99) - (groupOrder[b.group] || 99);
                if (groupDiff !== 0) return groupDiff;
                return a.percentage - b.percentage;
            });

            let currentGroup = '';
            let html = '';

            sortedQuotas.forEach(q => {
                if (q.group !== currentGroup) {
                    if (currentGroup) html += '</div>';
                    currentGroup = q.group;
                    html += `<div class="mb-3"><p class="text-xs text-text-muted uppercase tracking-wide mb-2">${q.group}</p>`;
                }

                const statusClass = q.percentage >= 50 ? 'text-status-healthy' :
                                   q.percentage >= 20 ? 'text-status-caution' : 'text-status-critical';
                const bgClass = q.percentage >= 50 ? 'bg-status-healthy' :
                               q.percentage >= 20 ? 'bg-status-caution' : 'bg-status-critical';

                html += `
                    <div class="flex items-center justify-between py-1.5 border-b border-border-subtle last:border-0">
                        <div class="flex-1 min-w-0 pr-3">
                            <p class="text-xs text-text-primary truncate font-mono" title="${q.name}">${q.name}</p>
                        </div>
                        <div class="flex items-center gap-3 flex-shrink-0">
                            <span class="text-[10px] text-text-muted font-mono">${q.resetIn}</span>
                            <div class="w-16 h-1 bg-bg-tertiary rounded-full overflow-hidden">
                                <div class="h-full rounded-full ${bgClass}" style="width: ${q.percentage}%"></div>
                            </div>
                            <span class="text-xs font-mono w-10 text-right ${statusClass}">${q.percentage.toFixed(0)}%</span>
                        </div>
                    </div>
                `;
            });

            if (currentGroup) html += '</div>';
            content.innerHTML = html;

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // Close modal
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Close modal on escape
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
        });

        // Helper to get status color class
        function getStatusClass(percentage) {
            if (percentage >= 50) return 'text-status-healthy';
            if (percentage >= 20) return 'text-status-caution';
            return 'text-status-critical';
        }

        // Calculate and display averages
        function updateAverages() {
            const groups = { 'Claude': [], 'Gemini Pro': [], 'Gemini Flash': [] };

            dashboardData.accounts.forEach(account => {
                if (account.groupQuotas) {
                    Object.entries(account.groupQuotas).forEach(([name, gq]) => {
                        if (groups[name] !== undefined) {
                            groups[name].push(gq.minPercent);
                        }
                    });
                }
            });

            const elements = {
                'Claude': 'claudeAvg',
                'Gemini Pro': 'geminiProAvg',
                'Gemini Flash': 'geminiFlashAvg'
            };

            Object.entries(groups).forEach(([name, values]) => {
                const el = document.getElementById(elements[name]);
                if (el && values.length > 0) {
                    const avg = values.reduce((a, b) => a + b, 0) / values.length;
                    el.textContent = avg.toFixed(0) + '%';
                    el.className = `text-2xl font-semibold font-mono ${getStatusClass(avg)}`;
                } else if (el) {
                    el.textContent = '--';
                    el.className = 'text-2xl font-semibold text-white font-mono';
                }
            });
        }

        // Update countdown display
        function updateCountdown() {
            const circle = document.getElementById('countdownCircle');
            const text = document.getElementById('countdownText');

            if (circle && text) {
                const offset = CIRCLE_CIRCUMFERENCE * (1 - countdown / REFRESH_INTERVAL);
                circle.style.strokeDashoffset = offset;
                // Format as minutes:seconds or just minutes
                if (countdown >= 60) {
                    const mins = Math.floor(countdown / 60);
                    const secs = countdown % 60;
                    text.textContent = secs > 0 ? `${mins}m` : `${mins}m`;
                } else {
                    text.textContent = `${countdown}s`;
                }
            }
        }

        // Start countdown timer
        function startCountdown() {
            countdown = REFRESH_INTERVAL;
            updateCountdown();

            if (countdownInterval) clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                countdown--;
                updateCountdown();

                if (countdown <= 0) {
                    autoRefresh();
                }
            }, 1000);
        }

        // Auto refresh
        async function autoRefresh() {
            if (isRefreshing) return;

            try {
                const response = await fetch('/api/quota');
                const newData = await response.json();

                if (newData.lastUpdated !== dashboardData.lastUpdated) {
                    dashboardData = newData;
                    document.getElementById('lastUpdated').textContent = dashboardData.lastUpdated;
                    document.getElementById('totalAccounts').textContent = dashboardData.totalAccounts;
                    updateAverages();
                }
            } catch (error) {
                console.error('Auto-refresh failed:', error);
            }

            startCountdown();
        }

        // Manual refresh
        async function refreshData() {
            if (isRefreshing) return;
            isRefreshing = true;

            const btn = document.getElementById('refreshBtn');
            const icon = document.getElementById('refreshIcon');

            btn.disabled = true;
            btn.classList.add('opacity-50');
            icon.classList.add('animate-spin');

            if (countdownInterval) clearInterval(countdownInterval);
            document.getElementById('countdownText').textContent = '...';

            try {
                const response = await fetch('/api/quota?refresh=true');
                dashboardData = await response.json();

                document.getElementById('lastUpdated').textContent = dashboardData.lastUpdated;
                document.getElementById('totalAccounts').textContent = dashboardData.totalAccounts;
                updateAverages();
            } catch (error) {
                console.error('Refresh failed:', error);
            } finally {
                isRefreshing = false;
                btn.disabled = false;
                btn.classList.remove('opacity-50');
                icon.classList.remove('animate-spin');
                startCountdown();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateAverages();
            startCountdown();
        });
    </script>
</body>
</html>
